<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Memoï¼‹</title>
<meta name="theme-color" content="#0f172a" />
<meta name="description" content="æ”¹ã–ã‚“æ¤œçŸ¥ï¼‹æš—å·åŒ–ï¼‹ç”»åƒæ·»ä»˜ã€‚ã‚«ãƒ†ã‚´ãƒª/æ¤œç´¢(AND/OR)/ä¸¦ã³æ›¿ãˆ/æå‡ºç”¨PDF/æ„Ÿæƒ…ãƒœã‚¿ãƒ³ï¼†å¯„ã‚Šæ·»ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ããƒ¡ãƒ¢ã‚¢ãƒ—ãƒª" />

<!-- UI -->
<script src="https://cdn.tailwindcss.com"><\/script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"><\/script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"><\/script>

<!-- icons (é‡è¦: icon.png / apple-touch-icon.png ã‚’åŒéšå±¤ã«ç½®ã) -->
<link rel="icon" type="image/png" sizes="512x512" href="./icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link id="manifest-link" rel="manifest" href="">

<style>
  :root { color-scheme: light; }
  html,body { height:100%; }
  /* ç”»é¢å°åˆ·(é€šå¸¸ã®Ctrl+P)ã§ã¯UIã‚’æ¶ˆã™ï¼ˆãŸã ã—ä»Šå›ã®ç›¸è«‡ç”¨PDFã¯åˆ¥çª“æ–¹å¼ãªã®ã§ä¿é™ºï¼‰ */
  @media print {
    header, form, .print-hide, .no-print { display:none !important; }
    body{ background:#fff !important; }
    li{ break-inside: avoid; }
  }
</style>
</head>

<body class="bg-slate-50">
<div id="root"></div>

<script type="module">
const {useState,useEffect,useMemo} = React;

/* ===================== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== */
const enc = new TextEncoder(), dec = new TextDecoder();
const LS_KEY="memo_plus_store_v5";
const jpTime = d => new Date(d).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",hour12:false});
const toHex = buf => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
async function sha256Hex(t){return toHex(await crypto.subtle.digest("SHA-256",enc.encode(t)))}
function uuid(){
  const a=crypto.getRandomValues(new Uint8Array(16));
  a[6]=(a[6]&15)|64; a[8]=(a[8]&63)|128;
  return [...a].map((b,i)=>(i===4||i===6||i===8||i===10?"-":"")+b.toString(16).padStart(2,"0")).join("")
}
const b64enc = bytes => btoa(String.fromCharCode(...bytes));
const b64dec = b64 => new Uint8Array(atob(b64).split("").map(c=>c.charCodeAt(0)));

async function deriveKey(pw,salt){
  const km=await crypto.subtle.importKey("raw",enc.encode(pw),{name:"PBKDF2"},false,["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2",salt,iterations:120000,hash:"SHA-256"},
    km,
    {name:"AES-GCM",length:256},
    false,
    ["encrypt","decrypt"]
  );
}
async function encryptJson(obj,pw){
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pw,salt);
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(JSON.stringify(obj)));
  return {salt:b64enc(salt),iv:b64enc(iv),data:b64enc(new Uint8Array(ct))};
}
async function decryptJson(payload,pw){
  const salt=b64dec(payload.salt),iv=b64dec(payload.iv),ct=b64dec(payload.data);
  const key=await deriveKey(pw,salt);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
  return JSON.parse(dec.decode(new Uint8Array(pt)));
}

/* ===================== æ„Ÿæƒ…ï¼†å¯„ã‚Šæ·»ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===================== */
const MOODS=[
  {key:"positive",label:"å‰å‘ã",emoji:"ğŸ™‚"},
  {key:"normal",label:"ãµã¤ã†",emoji:"ğŸ˜¶"},
  {key:"hard",label:"ã—ã‚“ã©ã„",emoji:"ğŸ¥²"},
  {key:"angry",label:"ã„ã‚‰ã ã¡",emoji:"ğŸ˜¡"},
  {key:"tired",label:"ã¤ã‹ã‚Œ",emoji:"ğŸ˜´"},
];
const SUPPORT={
  positive:[
    "ã„ã„æµã‚Œã€ã¡ã‚ƒã‚“ã¨æ´ã‚ã¦ã‚‹ã€‚ä»Šæ—¥ã®è‡ªåˆ†ã‚’è¤’ã‚ã¦ã‚ã’ã¦ã­ã€‚",
    "å‰ã«é€²ã‚ãŸã­ã€‚å°ã•ãªä¸€æ­©ã§ã‚‚ç©ã¿é‡ã­ã¯åŠ›ã«ãªã‚‹ã‚ˆã€‚",
    "è½ã¡ç€ã„ã¦é€²ã‚ã‚‰ã‚Œã¦ã‚‹ã€‚è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§OKã€‚"
  ],
  normal:[
    "æ·¡ã€…ã¨ç¶šã‘ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨è‡ªä½“ãŒå¤§ããªå¼·ã•ã ã‚ˆã€‚",
    "å¤§ä¸ˆå¤«ã€ååˆ†ã§ãã¦ã‚‹ã€‚å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã‹ã‚‰ã­ã€‚",
    "æ·±å‘¼å¸ã€‚ã„ã¾å‡ºæ¥ã‚‹ç¯„å›²ã§ã‚³ãƒ„ã‚³ãƒ„ã„ã“ã†ã€‚"
  ],
  hard:[
    "ã—ã‚“ã©ã„ä¸­ã€ã“ã“ã¾ã§è¨˜éŒ²ã§ããŸã“ã¨ãŒã™ã§ã«ç«‹æ´¾ã ã‚ˆã€‚",
    "ã¤ã‚‰ã„ã­ã€‚ä»Šæ—¥ã¯è‡ªåˆ†ã‚’å®ˆã‚‹é¸æŠã‚’æœ€å„ªå…ˆã§ã€‚",
    "æ°—æŒã¡ã‚’è¨€è‘‰ã«ã§ããŸã®ã¯å¼·ã•ã€‚ã‚ãªãŸã¯ä¸€äººã˜ã‚ƒãªã„ã‚ˆã€‚"
  ],
  angry:[
    "ãã®æ„Ÿæƒ…ã¯æ­£å½“ã ã‚ˆã€‚äº‹å®Ÿã‚’æ·¡ã€…ã¨æ®‹ã›ãŸè‡ªåˆ†ã‚’å‰ã„ã£ã¦è¨€ã£ã¦ã‚ã’ã¦ã€‚",
    "ã‚¤ãƒ©ãƒƒã¨ã—ãŸã­ã€‚å®‰å…¨ç¬¬ä¸€ã§ã€ä»Šæ—¥ã¯è‡ªåˆ†ã‚’å®ˆã‚‹è¡Œå‹•ã‚’å„ªå…ˆã—ã¦ã­ã€‚",
    "è½ã¡ç€ã„ãŸã‚‰æ·±å‘¼å¸ã€‚æ€’ã‚Šã¯è¡Œå‹•ã«å¤‰ã‚ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«ã‚‚ãªã‚‹ã‚ˆã€‚"
  ],
  tired:[
    "ã‚ˆãé ‘å¼µã£ãŸã­ã€‚ä»Šæ—¥ã¯å°‘ã—ã§ã‚‚ä¼‘ã‚ã‚‹æ™‚é–“ã‚’ä½œã‚ã†ã€‚",
    "ç–²ã‚Œã¦ã„ã‚‹æ™‚ã“ãâ€œæœ€å°ã®ä¸€æ­©â€ã€‚è¨˜éŒ²ã§ããŸæ™‚ç‚¹ã§åˆæ ¼ã ã‚ˆã€‚",
    "æ°´åˆ†è£œçµ¦ã—ã¦ã­ã€‚ä¼‘ã‚€å‹‡æ°—ã‚‚å¤§åˆ‡ã€‚"
  ]
};
function pickSupport(k){
  const a=SUPPORT[k]||SUPPORT.normal;
  return a[Math.floor(Math.random()*a.length)];
}

/* ===================== ãƒ‡ãƒ¼ã‚¿å½¢ ===================== */
function emptyStore(){return {version:5,requiresPassword:false,entries:[],images:{}}}
function entryMaterial(e){
  return [e.id,e.createdAt,e.sealedAt??"",e.title,e.category,e.note,(e.imageId||""),(e.moodKey||"")].join("|");
}

/* ===================== ç›¸è«‡ç”¨PDFï¼ˆæ–‡ç« ã ã‘ï¼‰ ===================== */
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function buildConsultHtml(entries){
  const rows = entries.map((e,i)=>{
    const moodDef = e.moodKey ? MOODS.find(m=>m.key===e.moodKey) : null;
    const title = escapeHtml(e.title || "ï¼ˆç„¡é¡Œï¼‰");
    const cat = escapeHtml(e.category || "");
    const created = escapeHtml(jpTime(e.createdAt));
    const sealed = e.sealedAt ? escapeHtml(jpTime(e.sealedAt)) : "";
    const mood = moodDef ? escapeHtml(`${moodDef.emoji} ${moodDef.label}`) : "";
    const note = escapeHtml(e.note||"").replaceAll("\n","<br>");
    return `
      <div class="card">
        <div class="meta">
          <div><span class="k">No.</span> ${i+1}</div>
          <div><span class="k">ä½œæˆ</span> ${created}${sealed?`ã€€<span class="k">å°å°</span> ${sealed}`:""}</div>
        </div>
        <div class="line"><span class="k">ã‚¿ã‚¤ãƒˆãƒ«</span> ${title}</div>
        <div class="line"><span class="k">ã‚«ãƒ†ã‚´ãƒª</span> ${cat}${mood?`ã€€<span class="k">æ°—æŒã¡</span> ${mood}`:""}</div>
        <div class="body">${note || "<span class='muted'>ï¼ˆæœ¬æ–‡ãªã—ï¼‰</span>"}</div>
      </div>
    `;
  }).join("");

  const now = escapeHtml(jpTime(new Date().toISOString()));
  return `<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç›¸è«‡ç”¨PDF - Memoï¼‹</title>
<style>
  body{ font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; margin:24px; color:#111; }
  h1{ font-size:18px; margin:0 0 8px; }
  .sub{ font-size:12px; color:#555; margin-bottom:16px; }
  .card{ border:1px solid #ddd; border-radius:10px; padding:12px 14px; margin:0 0 12px; page-break-inside:avoid; }
  .meta{ display:flex; justify-content:space-between; gap:12px; font-size:12px; color:#444; margin-bottom:8px; }
  .k{ color:#666; margin-right:6px; }
  .line{ font-size:13px; margin:2px 0; }
  .body{ margin-top:10px; font-size:13px; line-height:1.6; white-space:normal; }
  .muted{ color:#777; }
  @media print { body{ margin:10mm; } }
</style>
</head>
<body>
  <h1>ç›¸è«‡ç”¨PDFï¼ˆè¨˜éŒ²ä¸€è¦§ï¼‰</h1>
  <div class="sub">å‡ºåŠ›æ—¥æ™‚ï¼š${now}ã€€/ã€€ä»¶æ•°ï¼š${entries.length}ã€€/ã€€ç”Ÿæˆï¼šMemoï¼‹</div>
  ${rows || "<div class='muted'>ï¼ˆå‡ºåŠ›å¯¾è±¡ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>"}
  <script>
    // ç”Ÿæˆå¾Œã™ãå°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆå¿…è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆOKï¼‰
    setTimeout(()=>window.print(), 250);
  <\/script>
</body></html>`;
}
function printConsultPDF(entries){
  const html = buildConsultHtml(entries);
  const w = window.open("", "_blank");
  if(!w){ alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚"); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ===================== App ===================== */
function App(){
  const [tab,setTab]=useState("list"); // list | calendar | stats
  const [store,setStore]=useState(null);

  const [password,setPassword]=useState("");      // ã‚»ãƒƒã‚·ãƒ§ãƒ³PW
  const [locked,setLocked]=useState(false);
  const [hasEncrypted,setHasEncrypted]=useState(false);
  const [msg,setMsg]=useState("");

  // çµã‚Šè¾¼ã¿ãƒ»æ¤œç´¢
  const [filterCat,setFilterCat]=useState("all");
  const [searchMode,setSearchMode]=useState("AND");
  const [searchText,setSearchText]=useState("");
  const [sortMode,setSortMode]=useState("newest");

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  const [calYM,setCalYM]=useState(()=> {
    const d=new Date();
    return {y:d.getFullYear(), m:d.getMonth()}; // m:0-11
  });
  const [calDay,setCalDay]=useState(null); // "YYYY-MM-DD"

  useEffect(()=>{
    const encPayload=localStorage.getItem(LS_KEY+"_enc");
    if(encPayload){ setHasEncrypted(true); setLocked(true); }
    else{
      const plain=localStorage.getItem(LS_KEY);
      setStore(plain?JSON.parse(plain):emptyStore());
    }
  },[]);
  useEffect(()=>{ if(hasEncrypted) setLocked(true); },[hasEncrypted]);

  async function persist(next){
    if(next.requiresPassword){
      if(!password){ setMsg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªå…¥åŠ›ã€‚ãƒ­ãƒƒã‚¯è¨­å®šã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­ã€‚"); return; }
      const encObj=await encryptJson(next,password);
      localStorage.removeItem(LS_KEY);
      localStorage.setItem(LS_KEY+"_enc",JSON.stringify(encObj));
      setHasEncrypted(true);
    }else{
      localStorage.removeItem(LS_KEY+"_enc");
      localStorage.setItem(LS_KEY,JSON.stringify(next));
      setHasEncrypted(false);
    }
    setStore(next);
  }
  async function unlock(pw){
    try{
      const payload=JSON.parse(localStorage.getItem(LS_KEY+"_enc"));
      const data=await decryptJson(payload,pw);
      setPassword(pw); setStore(data); setLocked(false); setMsg("");
    }catch{
      setMsg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
    }
  }

  // ç”»åƒ
  async function addImage(file){
    if(!file) return {id:null};
    if(!/image\/(png|jpeg)/.test(file.type)){ setMsg("PNG/JPEGã®ã¿è¨±å¯"); return {id:null}; }
    if(file.size>5*1024*1024){ setMsg("ç”»åƒã¯5MBä»¥ä¸‹ã«ã—ã¦ã­"); return {id:null}; }
    const r=new FileReader();
    const dataURL=await new Promise((res,rej)=>{ r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    const id=uuid();
    await persist({...store,images:{...(store.images||{}),[id]:dataURL}});
    return {id};
  }

  // CRUD
  async function addEntry({title,category,note,imageId,moodKey}){
    const now=new Date().toISOString();
    const prev=store.entries[store.entries.length-1]?.hash ?? "GENESIS";
    const draft={
      id:uuid(),
      createdAt:now,
      sealedAt:null,
      title:title.trim(),
      category,
      note,
      imageId:imageId||null,
      moodKey:moodKey||null,
      prevHash:prev,
      hash:""
    };
    draft.hash=await sha256Hex(prev+"|"+entryMaterial(draft));
    await persist({...store,entries:[...store.entries,draft]});
    if(moodKey){
      setMsg(pickSupport(moodKey));
      setTimeout(()=>setMsg(""),6000);
    }
  }
  async function editEntry(id,fields){
    const idx=store.entries.findIndex(e=>e.id===id);
    if(idx<0||store.entries[idx].sealedAt) return;

    const arr=[...store.entries];
    arr[idx]={...arr[idx],...fields};

    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){
      arr[i].prevHash=prev;
      arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));
      prev=arr[i].hash;
    }
    await persist({...store,entries:arr});
  }
  async function sealEntry(id){
    const idx=store.entries.findIndex(e=>e.id===id);
    if(idx<0||store.entries[idx].sealedAt) return;

    const arr=[...store.entries];
    arr[idx]={...arr[idx],sealedAt:new Date().toISOString()};

    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){
      arr[i].prevHash=prev;
      arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));
      prev=arr[i].hash;
    }
    await persist({...store,entries:arr});
  }
  async function removeEntry(id){
    const idx=store.entries.findIndex(e=>e.id===id);
    if(idx<0||store.entries[idx].sealedAt) return;

    const arr=store.entries.filter(e=>e.id!==id);

    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){
      arr[i].prevHash=prev;
      arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));
      prev=arr[i].hash;
    }
    await persist({...store,entries:arr});
  }

  // I/O
  function exportJson(){
    const blob=new Blob([JSON.stringify(store,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`memo-plus-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
  function importJson(file){
    const r=new FileReader();
    r.onload=async()=>{
      try{
        const obj=JSON.parse(r.result);
        if(!Array.isArray(obj.entries)) throw 0;
        await persist(obj);
      }catch{
        setMsg("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—");
      }
    };
    r.readAsText(file);
  }

  // çµã‚Šè¾¼ã¿/æ¤œç´¢/ä¸¦ã³æ›¿ãˆ
  function applyFilters(base){
    let arr=[...base];

    if(filterCat!=="all") arr=arr.filter(e=>e.category===filterCat);

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ã®çµã‚Šè¾¼ã¿
    if(calDay){
      arr = arr.filter(e=>{
        const d = new Date(e.createdAt);
        const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,"0"), day=d.getDate().toString().padStart(2,"0");
        const key = `${y}-${m}-${day}`;
        return key===calDay;
      });
    }

    if(searchText.trim()){
      const words=searchText.trim().split(/\s+/);
      arr=arr.filter(e=>{
        const hay=(e.title+"\n"+e.note+"\n"+(e.category||"")+"\n"+(e.moodKey||"")).toLowerCase();
        return (searchMode==="AND")
          ? words.every(w=>hay.includes(w.toLowerCase()))
          : words.some(w=>hay.includes(w.toLowerCase()));
      });
    }

    if(sortMode==="newest") arr.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    if(sortMode==="oldest") arr.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));

    return arr;
  }

  const filtered = useMemo(()=>{
    if(!store) return [];
    return applyFilters(store.entries);
  },[store,filterCat,searchMode,searchText,sortMode,calDay]);

  // ãƒ­ãƒƒã‚¯ç”»é¢
  if(locked && hasEncrypted){
    return React.createElement('div',{className:"min-h-screen bg-slate-50 p-6"},
      React.createElement('div',{className:"max-w-xl mx-auto bg-white rounded-2xl shadow p-6"},
        React.createElement('h1',{className:"text-2xl font-bold mb-2"},"ğŸ” Memoï¼‹ï¼ˆéµä»˜ãï¼‰"),
        React.createElement('p',{className:"text-sm text-slate-600 mb-6"},"ç«¯æœ«å†…ã®æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§è§£éŒ ã—ã¦ãã ã•ã„ã€‚"),
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",onChange:e=>setPassword(e.target.value)}),
        React.createElement('button',{onClick:()=>unlock(password),className:"mt-4 w-full rounded-xl p-3 bg-slate-900 text-white"},"è§£éŒ ã™ã‚‹"),
        msg && React.createElement('p',{className:"mt-3 text-red-600 text-sm"},msg)
      )
    );
  }
  if(!store) return React.createElement('div',{className:"p-6"},"èª­ã¿è¾¼ã¿ä¸­â€¦");

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼šå½“æœˆã®æ—¥åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
  const calInfo = useMemo(()=>{
    const y=calYM.y, m=calYM.m;
    const first = new Date(y,m,1);
    const last  = new Date(y,m+1,0);
    const startDow = first.getDay(); // 0=Sun
    const days = last.getDate();

    const map = new Map();
    for(const e of store.entries){
      const d=new Date(e.createdAt);
      if(d.getFullYear()===y && d.getMonth()===m){
        const key=d.getDate();
        map.set(key,(map.get(key)||0)+1);
      }
    }
    return {y,m,days,startDow,map};
  },[store,calYM]);

  // çµ±è¨ˆ
  const stats = useMemo(()=>{
    const byCat = {};
    const byMood = {};
    for(const e of store.entries){
      const c=e.category||"æœªåˆ†é¡";
      byCat[c]=(byCat[c]||0)+1;
      const mk=e.moodKey||"none";
      byMood[mk]=(byMood[mk]||0)+1;
    }
    return {byCat,byMood,total:store.entries.length};
  },[store]);

  // Header
  return React.createElement(React.Fragment,null,
    React.createElement('header',{className:"sticky top-0 bg-white/90 border-b z-10"},
      React.createElement('div',{className:"max-w-6xl mx-auto px-4 py-3 flex flex-wrap gap-2 items-center justify-between"},
        React.createElement('div',{className:"flex items-center gap-3"},
          React.createElement('img',{src:"./icon.png",alt:"Memo+ icon",className:"w-8 h-8 rounded-lg border"}),
          React.createElement('div',null,
            React.createElement('div',{className:"font-bold text-lg"},"Memoï¼‹"),
            React.createElement('div',{className:"text-xs text-slate-500"},"æ”¹ã–ã‚“æ¤œçŸ¥ãƒ»éµä»˜ã")
          )
        ),

        React.createElement('div',{className:"flex flex-wrap gap-2 items-center"},
          React.createElement('div',{className:"flex bg-slate-100 rounded-xl p-1"},
            React.createElement('button',{
              className:"px-3 py-1.5 rounded-lg text-sm "+(tab==="list"?"bg-white shadow":"text-slate-600"),
              onClick:()=>{setTab("list"); setCalDay(null);}
            },"ä¸€è¦§"),
            React.createElement('button',{
              className:"px-3 py-1.5 rounded-lg text-sm "+(tab==="calendar"?"bg-white shadow":"text-slate-600"),
              onClick:()=>setTab("calendar")
            },"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"),
            React.createElement('button',{
              className:"px-3 py-1.5 rounded-lg text-sm "+(tab==="stats"?"bg-white shadow":"text-slate-600"),
              onClick:()=>setTab("stats")
            },"çµ±è¨ˆ")
          ),

          React.createElement('button',{
  className:"px-3 py-2 rounded-lg border",
  onClick:()=>window.print()
},"ç›¸è«‡ç”¨PDF")


          React.createElement('button',{className:"px-3 py-2 rounded-lg border",onClick:exportJson},"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"),
          React.createElement('label',{className:"px-3 py-2 rounded-lg border cursor-pointer"},"ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
            React.createElement('input',{
              type:"file",accept:"application/json",className:"hidden",
              onChange:e=>e.target.files?.[0]&&importJson(e.target.files[0])
            })
          )
        )
      )
    ),

    React.createElement('main',{className:"max-w-6xl mx-auto p-4 grid gap-6 sm:grid-cols-5"},
      /* å·¦ã‚«ãƒ©ãƒ ï¼šæ–°è¦è¨˜éŒ²ï¼‹ãƒ­ãƒƒã‚¯ï¼ˆå°åˆ·å¯¾è±¡å¤–ï¼‰ */
      React.createElement('div',{className:"sm:col-span-2 no-print"},
        React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
          React.createElement('h2',{className:"font-semibold mb-3"},"ğŸ“ æ–°è¦è¨˜éŒ²"),
          msg && React.createElement('div',{className:"mb-3 text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2"},"ğŸ’¬ ",msg),
          React.createElement(NewEntryForm,{onSubmit: async({title,category,note,file,moodKey})=>{
            let imageId=null;
            if(file){ const r=await addImage(file); imageId=r.id; }
            await addEntry({title,category,note,imageId,moodKey});
          }})
        ),
        React.createElement('section',{className:"bg-white rounded-2xl shadow p-4 mt-4"},
          React.createElement('h2',{className:"font-semibold mb-3"},"ğŸ” ãƒ­ãƒƒã‚¯è¨­å®š"),
          React.createElement(LockPanel,{store,setStore,password,setPassword,persist,setMsg})
        )
      ),

      /* å³ã‚«ãƒ©ãƒ ï¼šã‚¿ãƒ–ã§åˆ‡æ›¿ */
      React.createElement('div',{className:"sm:col-span-3"},
        tab==="list"
          ? React.createElement(ListView,{
              store, filtered,
              filterCat,setFilterCat,
              searchMode,setSearchMode,
              searchText,setSearchText,
              sortMode,setSortMode,
              calDay, setCalDay,
              editEntry, sealEntry, removeEntry
            })
          : tab==="calendar"
            ? React.createElement(CalendarView,{
                calInfo, calYM, setCalYM, calDay, setCalDay,
                store, setTab
              })
            : React.createElement(StatsView,{stats})
      )
    )
  );
}

/* -------------- ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¤œç´¢/ä¸¦ã³æ›¿ãˆ + è¨˜éŒ²ä¸€è¦§ï¼‰ -------------- */
function ListView(props){
  const {
    store, filtered,
    filterCat,setFilterCat,
    searchMode,setSearchMode,
    searchText,setSearchText,
    sortMode,setSortMode,
    calDay,setCalDay,
    editEntry, sealEntry, removeEntry
  } = props;

  return React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
    React.createElement('div',{className:"flex flex-wrap gap-2 mb-3 no-print"},
      React.createElement('select',{value:filterCat,onChange:e=>setFilterCat(e.target.value),className:"border rounded-lg p-2"},
        React.createElement('option',{value:"all"},"ã™ã¹ã¦"),
        ['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(c=>React.createElement('option',{key:c,value:c},c))
      ),
      React.createElement('select',{value:searchMode,onChange:e=>setSearchMode(e.target.value),className:"border rounded-lg p-2"},
        React.createElement('option',{value:"AND"},"ANDæ¤œç´¢"),
        React.createElement('option',{value:"OR"},"ORæ¤œç´¢")
      ),
      React.createElement('input',{type:"text",placeholder:"æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰",value:searchText,onChange:e=>setSearchText(e.target.value),className:"flex-1 border rounded-lg p-2"}),
      React.createElement('select',{value:sortMode,onChange:e=>setSortMode(e.target.value),className:"border rounded-lg p-2"},
        React.createElement('option',{value:"newest"},"æ–°ã—ã„é †"),
        React.createElement('option',{value:"oldest"},"å¤ã„é †")
      ),
      calDay && React.createElement('button',{
        className:"px-3 py-2 rounded-lg border bg-amber-50",
        onClick:()=>setCalDay(null)
      },`æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ï¼ˆ${calDay}ï¼‰`)
    ),

    filtered.length===0
      ? React.createElement('p',{className:"text-sm text-slate-500"},"è©²å½“ã™ã‚‹è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
      : React.createElement('ul',{className:"space-y-3"},
          filtered.map(e=>React.createElement(EntryCard,{
            key:e.id,e,images:store.images,
            editEntry,sealEntry,removeEntry
          }))
        )
  );
}

/* -------------- æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ  -------------- */
function NewEntryForm({onSubmit}){
  const [title,setTitle]=useState("");
  const [category,setCategory]=useState("è¦³å¯Ÿ");
  const [note,setNote]=useState("");
  const [file,setFile]=useState(null);
  const [mood,setMood]=useState(null);

  const handle=async(e)=>{
    e.preventDefault();
    if(!title.trim() && !note.trim() && !file) return;
    await onSubmit({title,category,note,file,moodKey:mood});
    setTitle(""); setCategory("è¦³å¯Ÿ"); setNote(""); setFile(null); setMood(null);
    e.target.reset();
  };

  return React.createElement('form',{onSubmit:handle,className:"space-y-3"},
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰"),
      React.createElement('input',{
        value:title,onChange:e=>setTitle(e.target.value),
        className:"w-full border rounded-xl p-3",
        placeholder:"ä¾‹ï¼šè¬›ç¿’ã¨è¨€ã£ã¦å¤–å‡º / æ”¯å‡ºãƒ¡ãƒ¢ / ä¼šè©±ã®è¦ç‚¹ ãªã©"
      })
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ã‚«ãƒ†ã‚´ãƒªãƒ¼"),
      React.createElement('select',{
        value:category,onChange:e=>setCategory(e.target.value),
        className:"w-full border rounded-xl p-3"
      },['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(x=>React.createElement('option',{key:x,value:x},x)))
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"æœ¬æ–‡"),
      React.createElement('textarea',{
        value:note,onChange:e=>setNote(e.target.value),
        className:"w-full border rounded-xl p-3 h-32",
        placeholder:`ä¾‹ï¼š${new Date().toLocaleString('ja-JP',{timeZone:'Asia/Tokyo',hour12:false})} è‡ªå®…ã‚’å‡ºç™ºã€‚ã‚³ãƒ³ãƒ“ãƒ‹ã§â—¯â—¯ã‚’è³¼å…¥ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆæ·»ä»˜ï¼‰ã€‚ãã®å¾Œâ—¯â—¯æ–¹é¢ã¸ã€‚å¸°å®…ã¯21:05ã€‚ä¼šè©±ã®è¦ç‚¹ï¼šâ€¦â€¦`
      })
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ä»Šæ—¥ã®æ°—æŒã¡ï¼ˆä»»æ„ï¼‰"),
      React.createElement('div',{className:"flex flex-wrap gap-2"},
        ...MOODS.map(m=>React.createElement('button',{
          type:"button",key:m.key,onClick:()=>setMood(m.key),
          className:"px-3 py-1 rounded-full border "+(mood===m.key?"bg-slate-900 text-white":"bg-white text-slate-700")
        },`${m.emoji} ${m.label}`))
      )
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ç”»åƒï¼ˆä»»æ„ãƒ»PNG/JPEGãƒ»5MBä»¥ä¸‹ï¼‰"),
      React.createElement('input',{
        type:"file",accept:"image/png,image/jpeg",
        onChange:e=>setFile(e.target.files?.[0]||null),
        className:"w-full border rounded-xl p-3"
      })
    ),
    React.createElement('button',{type:"submit",className:"w-full rounded-xl bg-slate-900 text-white p-3"},"ä»Šã™ãè¨˜éŒ²")
  );
}

/* -------------- ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -------------- */
function EntryCard({e,images,editEntry,sealEntry,removeEntry}){
  const [editing,setEditing]=useState(false);
  const [title,setTitle]=useState(e.title);
  const [category,setCategory]=useState(e.category);
  const [note,setNote]=useState(e.note);
  const img = e.imageId ? (images||{})[e.imageId] : null;

  useEffect(()=>{ setTitle(e.title); setCategory(e.category); setNote(e.note); },[e]);

  const moodDef = e.moodKey ? MOODS.find(m=>m.key===e.moodKey) : null;

  return React.createElement('li',{className:"rounded-xl border border-slate-200 bg-white p-4"},
    React.createElement('div',{className:"text-xs text-slate-500"},
      "ä½œæˆ: ",jpTime(e.createdAt),
      e.sealedAt?` ï¼ å°å°: ${jpTime(e.sealedAt)}`:""
    ),

    editing
      ? React.createElement('div',{className:"mt-2 space-y-2 no-print"},
          React.createElement('input',{className:"w-full border rounded-xl p-2",value:title,onChange:e=>setTitle(e.target.value)}),
          React.createElement('select',{className:"w-full border rounded-xl p-2",value:category,onChange:e=>setCategory(e.target.value)},
            ['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(x=>React.createElement('option',{key:x,value:x},x))
          ),
          React.createElement('textarea',{className:"w-full border rounded-xl p-2 h-28",value:note,onChange:e=>setNote(e.target.value)})
        )
      : React.createElement(React.Fragment,null,
          React.createElement('h3',{className:"mt-1 font-semibold"},e.title||"ï¼ˆç„¡é¡Œï¼‰"),
          React.createElement('div',{className:"flex gap-2 items-center mt-1"},
            React.createElement('span',{className:"text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border"},e.category),
            moodDef && React.createElement('span',{className:"text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 border"},`${moodDef.emoji} ${moodDef.label}`)
          ),
          img && React.createElement('img',{src:img,alt:"æ·»ä»˜ç”»åƒ",className:"mt-3 max-h-64 rounded-lg border no-print"}),
          React.createElement('p',{className:"mt-2 whitespace-pre-wrap text-sm"},e.note)
        ),

    React.createElement('div',{className:"mt-3 flex items-center gap-2 no-print"},
      !e.sealedAt
        ? React.createElement(React.Fragment,null,
            editing
              ? React.createElement(React.Fragment,null,
                  React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>setEditing(false)},"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"),
                  React.createElement('button',{className:"px-3 py-1 rounded-lg bg-slate-900 text-white",onClick:()=>{ editEntry(e.id,{title,category,note}); setEditing(false);} },"ä¿å­˜")
                )
              : React.createElement(React.Fragment,null,
                  React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>setEditing(true)},"ç·¨é›†"),
                  React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>removeEntry(e.id)},"å‰Šé™¤"),
                  React.createElement('button',{className:"ml-auto px-3 py-1 rounded-lg bg-emerald-600 text-white",onClick:()=>sealEntry(e.id)},"å°å°ï¼ˆç¢ºå®šï¼‰")
                )
          )
        : React.createElement('span',{className:"ml-auto text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border"},"å°å°æ¸ˆã¿ãƒ»ç·¨é›†ä¸å¯")
    )
  );
}

/* -------------- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -------------- */
function CalendarView({calInfo, calYM, setCalYM, calDay, setCalDay, store, setTab}){
  const {y,m,days,startDow,map} = calInfo;
  const monthLabel = `${y}å¹´ ${m+1}æœˆ`;

  const prevMonth = ()=> {
    const d=new Date(y,m,1); d.setMonth(d.getMonth()-1);
    setCalYM({y:d.getFullYear(), m:d.getMonth()});
  };
  const nextMonth = ()=> {
    const d=new Date(y,m,1); d.setMonth(d.getMonth()+1);
    setCalYM({y:d.getFullYear(), m:d.getMonth()});
  };

  const cells = [];
  for(let i=0;i<startDow;i++) cells.push(null);
  for(let d=1; d<=days; d++) cells.push(d);
  while(cells.length%7!==0) cells.push(null);

  return React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
    React.createElement('div',{className:"flex items-center justify-between mb-3"},
      React.createElement('button',{className:"px-3 py-2 rounded-lg border",onClick:prevMonth},"â†"),
      React.createElement('div',{className:"font-semibold"},monthLabel),
      React.createElement('button',{className:"px-3 py-2 rounded-lg border",onClick:nextMonth},"â†’")
    ),
    React.createElement('div',{className:"grid grid-cols-7 gap-2 text-xs text-slate-500 mb-2"},
      ..."æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ".split("").map((c,i)=>React.createElement('div',{key:i,className:"text-center"},c))
    ),
    React.createElement('div',{className:"grid grid-cols-7 gap-2"},
      ...cells.map((d,idx)=>{
        if(!d) return React.createElement('div',{key:idx,className:"h-14 rounded-lg bg-slate-50 border"});
        const count = map.get(d)||0;
        const key = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const active = calDay===key;
        return React.createElement('button',{
          key:idx,
          className:"h-14 rounded-lg border text-left p-2 "+(active?"bg-amber-50 border-amber-300":"bg-white"),
          onClick:()=>{
            if(count===0) return;
            setCalDay(key);
            setTab("list");
          }
        },
          React.createElement('div',{className:"text-sm font-semibold"},d),
          React.createElement('div',{className:"text-xs text-slate-500"}, count?`${count}ä»¶`:"")
        );
      })
    ),
    React.createElement('p',{className:"mt-3 text-sm text-slate-600"},
      "â€» æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®æ—¥ã®è¨˜éŒ²ã ã‘ã«çµã£ã¦ã€Œä¸€è¦§ã€ã¸ç§»å‹•ã—ã¾ã™ï¼ˆ0ä»¶ã®æ—¥ã¯é¸ã¹ã¾ã›ã‚“ï¼‰"
    )
  );
}

/* -------------- çµ±è¨ˆ -------------- */
function StatsView({stats}){
  const catRows = Object.entries(stats.byCat).sort((a,b)=>b[1]-a[1]);
  const moodRows = Object.entries(stats.byMood).sort((a,b)=>b[1]-a[1]);

  const moodName = (k)=>{
    if(k==="none") return "ï¼ˆæœªé¸æŠï¼‰";
    const d=MOODS.find(x=>x.key===k);
    return d?`${d.emoji} ${d.label}`:k;
  };

  return React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
    React.createElement('h2',{className:"font-semibold mb-3"},"ğŸ“Š çµ±è¨ˆ"),
    React.createElement('p',{className:"text-sm text-slate-600 mb-4"},`åˆè¨ˆ ${stats.total} ä»¶`),

    React.createElement('div',{className:"grid gap-4"},
      React.createElement('div',{className:"rounded-xl border p-3"},
        React.createElement('div',{className:"font-semibold mb-2"},"ã‚«ãƒ†ã‚´ãƒªåˆ¥"),
        catRows.length===0
          ? React.createElement('div',{className:"text-sm text-slate-500"},"ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
          : React.createElement('ul',{className:"text-sm space-y-1"},
              ...catRows.map(([k,v])=>React.createElement('li',{key:k,className:"flex justify-between"},
                React.createElement('span',null,k),
                React.createElement('span',{className:"text-slate-600"},v)
              ))
            )
      ),
      React.createElement('div',{className:"rounded-xl border p-3"},
        React.createElement('div',{className:"font-semibold mb-2"},"æ°—æŒã¡åˆ¥"),
        moodRows.length===0
          ? React.createElement('div',{className:"text-sm text-slate-500"},"ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
          : React.createElement('ul',{className:"text-sm space-y-1"},
              ...moodRows.map(([k,v])=>React.createElement('li',{key:k,className:"flex justify-between"},
                React.createElement('span',null,moodName(k)),
                React.createElement('span',{className:"text-slate-600"},v)
              ))
            )
      )
    )
  );
}

/* -------------- ãƒ­ãƒƒã‚¯è¨­å®š -------------- */
function LockPanel({store,setStore,password,setPassword,persist,setMsg}){
  const [pw1,setPw1]=useState(""), [pw2,setPw2]=useState("");

  if(!store.requiresPassword){
    return React.createElement('div',null,
      React.createElement('p',{className:"text-sm text-slate-600"},
        "ç¾åœ¨ï¼š",React.createElement('span',{className:"font-semibold"},"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®š"),"ï¼ˆå¹³æ–‡ä¿å­˜ï¼‰"
      ),
      React.createElement('div',{className:"mt-3 space-y-2"},
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",value:pw1,onChange:e=>setPw1(e.target.value)}),
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",value:pw2,onChange:e=>setPw2(e.target.value)}),
        React.createElement('button',{
          disabled:!pw1||pw1!==pw2,
          onClick:async()=>{
            const next={...(store||emptyStore()),requiresPassword:true};
            setPassword(pw1);
            await persist(next);
            setMsg("æš—å·åŒ–ä¿å­˜ã«åˆ‡æ›¿ãˆã¾ã—ãŸï¼ˆä»¥å¾Œã¯è§£éŒ ãŒå¿…è¦ï¼‰");
          },
          className:"w-full rounded-xl bg-slate-900 text-white p-3 disabled:opacity-40"
        },"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦æš—å·åŒ–ä¿å­˜ã«åˆ‡æ›¿")
      ),
      React.createElement('p',{className:"mt-2 text-xs text-slate-500"},"â€» å¿˜ã‚Œã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€‚å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã‚’ã€‚")
    );
  }

  return React.createElement('div',null,
    React.createElement('p',{className:"text-sm text-slate-600"},
      "ç¾åœ¨ï¼š",React.createElement('span',{className:"font-semibold"},"æš—å·åŒ–ä¿å­˜"),"ï¼ˆAES-GCMï¼‰"
    ),
    React.createElement('div',{className:"mt-2 space-y-2"},
      React.createElement('p',{className:"text-xs text-slate-500"},
        "â€» ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒ­ãƒƒã‚¯ã¯ã€Œãƒ›ãƒ¼ãƒ è¿½åŠ (PWA)ã€åˆ©ç”¨ãŒæœ€é©ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã‚¿ãƒ–å¾©å¸°ã§è¦‹ãˆã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚"
      ),
      React.createElement('button',{
        onClick:()=>{
          // ç”»é¢ã‚’å³ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«æˆ»ã™ï¼ˆæ¬¡å›ã¯è§£éŒ ãŒå¿…è¦ï¼‰
          location.reload();
        },
        className:"w-full rounded-xl border p-3"
      },"ä»Šã™ãç”»é¢ã‚’ãƒ­ãƒƒã‚¯ï¼ˆå†èª­ã¿è¾¼ã¿ï¼‰")
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
<\/script>

<!-- ===== PWAï¼šmanifestå‹•çš„ç”Ÿæˆ & Service Workerç™»éŒ² ===== -->
<script>
(function(){
  // manifest ã‚’å‹•çš„ç”Ÿæˆï¼ˆGitHub Pagesã®ç›¸å¯¾ãƒ‘ã‚¹ã«å¼·ãã™ã‚‹ï¼‰
  const manifest = {
    name: "Memoï¼‹",
    short_name: "Memoï¼‹",
    start_url: "./index.html",
    scope: "./",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#0f172a",
    icons: [
      { src: "./icon.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ]
  };
  const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"}));
  document.getElementById("manifest-link").setAttribute("href", url);

  // Service Workerï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³&ã‚¢ã‚¤ã‚³ãƒ³å–å¾—å®‰å®šï¼‰
  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE='memo-plus-v5';
      const ASSETS=['./','./index.html','./icon.png','./apple-touch-icon.png'];
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));
        self.skipWaiting();
      });
      self.addEventListener('activate',e=>{
        e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
        self.clients.claim();
      });
      self.addEventListener('fetch',e=>{
        e.respondWith(
          caches.match(e.request).then(r=>r||fetch(e.request).then(x=>{
            const y=x.clone();
            caches.open(CACHE).then(c=>c.put(e.request,y)).catch(()=>{});
            return x;
          }).catch(()=>r))
        );
      });
    `;
    const swUrl = URL.createObjectURL(new Blob([swCode],{type:"text/javascript"}));
    window.addEventListener('load', ()=>navigator.serviceWorker.register(swUrl,{scope:"./"}));
  }
})();
<\/script>
</body>
</html>
