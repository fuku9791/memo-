<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Memoï¼‹</title>
<meta name="theme-color" content="#0f172a" />
<meta name="description" content="æ”¹ã–ã‚“æ¤œçŸ¥ï¼‹æš—å·åŒ–ï¼‹ç”»åƒæ·»ä»˜ã€‚ã‚«ãƒ†ã‚´ãƒª/æ¤œç´¢(AND/OR)/ä¸¦ã³æ›¿ãˆ/æå‡ºç”¨PDF/æ„Ÿæƒ…ãƒœã‚¿ãƒ³ï¼†å¯„ã‚Šæ·»ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ããƒ¡ãƒ¢ã‚¢ãƒ—ãƒª" />

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- icons -->
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<link id="manifest-link" rel="manifest" href="">
<style>
  @media print {
    header, form, .print-hide { display:none !important; }
    body{ background:#fff; }
    li{ break-inside: avoid; }
  }
</style>
</head>
<body class="bg-slate-50">
<div id="root"></div>

<script type="module">
const {useState,useEffect} = React;

/* ===================== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== */
const enc = new TextEncoder(), dec = new TextDecoder();
const LS_KEY="memo_plus_store_v4";
const jpTime = d => new Date(d).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",hour12:false});
const toHex = buf => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
async function sha256Hex(t){return toHex(await crypto.subtle.digest("SHA-256",enc.encode(t)))}
function uuid(){const a=crypto.getRandomValues(new Uint8Array(16));a[6]=(a[6]&15)|64;a[8]=(a[8]&63)|128;return [...a].map((b,i)=>(i===4||i===6||i===8||i===10?"-":"")+b.toString(16).padStart(2,"0")).join("")}
const b64enc = bytes => btoa(String.fromCharCode(...bytes));
const b64dec = b64 => new Uint8Array(atob(b64).split("").map(c=>c.charCodeAt(0)));
async function deriveKey(pw,salt){
  const km=await crypto.subtle.importKey("raw",enc.encode(pw),{name:"PBKDF2"},false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:120000,hash:"SHA-256"},km,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encryptJson(obj,pw){
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pw,salt);
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(JSON.stringify(obj)));
  return {salt:b64enc(salt),iv:b64enc(iv),data:b64enc(new Uint8Array(ct))};
}
async function decryptJson(payload,pw){
  const salt=b64dec(payload.salt),iv=b64dec(payload.iv),ct=b64dec(payload.data);
  const key=await deriveKey(pw,salt);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
  return JSON.parse(dec.decode(new Uint8Array(pt)));
}

/* ===================== æ„Ÿæƒ…ï¼†å¯„ã‚Šæ·»ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===================== */
const MOODS=[
  {key:"positive",label:"å‰å‘ã",emoji:"ğŸ™‚"},
  {key:"normal",label:"ãµã¤ã†",emoji:"ğŸ˜¶"},
  {key:"hard",label:"ã—ã‚“ã©ã„",emoji:"ğŸ¥²"},
  {key:"angry",label:"ã„ã‚‰ã ã¡",emoji:"ğŸ˜¡"},
  {key:"tired",label:"ã¤ã‹ã‚Œ",emoji:"ğŸ˜´"},
];
const SUPPORT={
  positive:[
    "ã„ã„æµã‚Œã€ã¡ã‚ƒã‚“ã¨æ´ã‚ã¦ã‚‹ã€‚ä»Šæ—¥ã®è‡ªåˆ†ã‚’è¤’ã‚ã¦ã‚ã’ã¦ã­ã€‚",
    "å‰é€²ã§ããŸã­ã€‚å°ã•ãªä¸€æ­©ã§ã‚‚ç©ã¿é‡ã­ã¯åŠ›ã«ãªã‚‹ã‚ˆã€‚",
    "è½ã¡ç€ã„ã¦é€²ã‚ã‚‰ã‚Œã¦ã‚‹ã€ã™ã”ã„ã€‚è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§OKã€‚"
  ],
  normal:[
    "æ·¡ã€…ã¨ç¶šã‘ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨è‡ªä½“ãŒå¤§ããªå¼·ã•ã ã‚ˆã€‚",
    "å¤§ä¸ˆå¤«ã€ååˆ†ã§ãã¦ã‚‹ã€‚å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã‹ã‚‰ã­ã€‚",
    "å‘¼å¸ã‚’æ·±ãã€‚ä»Šã§ãã‚‹ç¯„å›²ã§ã‚³ãƒ„ã‚³ãƒ„ã„ã“ã†ã€‚"
  ],
  hard:[
    "ã—ã‚“ã©ã„ä¸­ã€ã“ã“ã¾ã§è¨˜éŒ²ã§ããŸã“ã¨ãŒã™ã§ã«ç«‹æ´¾ã ã‚ˆã€‚",
    "ã¤ã‚‰ã„ã­ã€‚ç„¡ç†ã—ã™ããªã„ã§ã€‚æ¸©ã‹ã„é£²ã¿ç‰©ã‚’ä¸€æ¯ã©ã†ï¼Ÿ",
    "æ°—æŒã¡ã‚’è¨€è‘‰ã«ã§ããŸã®ã¯å¼·ã•ã€‚ã‚ãªãŸã¯ä¸€äººã˜ã‚ƒãªã„ã‚ˆã€‚"
  ],
  angry:[
    "ãã®æ„Ÿæƒ…ã¯æ­£å½“ã ã‚ˆã€‚äº‹å®Ÿã‚’æ·¡ã€…ã¨æ®‹ã›ãŸè‡ªåˆ†ã‚’å‰ã„ã£ã¦è¨€ã£ã¦ã‚ã’ã¦ã€‚",
    "ã‚¤ãƒ©ãƒƒã¨ã—ãŸã­ã€‚å®‰å…¨ç¬¬ä¸€ã§ã€ä»Šæ—¥ã¯è‡ªåˆ†ã‚’å®ˆã‚‹é¸æŠã‚’å„ªå…ˆã—ã¦ã­ã€‚",
    "è½ã¡ç€ã„ãŸã‚‰æ·±å‘¼å¸ã€‚æ€’ã‚Šã¯è¡Œå‹•ã«å¤‰ã‚ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«ã‚‚ãªã‚‹ã‚ˆã€‚"
  ],
  tired:[
    "ã‚ˆãé ‘å¼µã£ãŸã­ã€‚ä»Šæ—¥ã¯æ—©ã‚ã«ä¼‘ã‚€æ™‚é–“ã€å°‘ã—ã§ã‚‚ä½œã‚ã†ã€‚",
    "ç–²ã‚Œã¦ã„ã‚‹æ™‚ã“ãâ€œæœ€å°ã®ä¸€æ­©â€ã€‚è¨˜éŒ²ã§ããŸæ™‚ç‚¹ã§åˆæ ¼ã ã‚ˆã€‚",
    "æ°´åˆ†è£œçµ¦ã—ã¦ã­ã€‚æ˜æ—¥ã®è‡ªåˆ†ã®ãŸã‚ã«ã€ã„ã¾ã¯ä¼‘ã‚€å‹‡æ°—ã‚‚å¤§åˆ‡ã€‚"
  ]
};
function pickSupport(k){const a=SUPPORT[k]||SUPPORT.normal;return a[Math.floor(Math.random()*a.length)]}

/* ===================== ãƒ‡ãƒ¼ã‚¿å½¢ ===================== */
function emptyStore(){return {version:4,requiresPassword:false,entries:[],images:{}}}
function entryMaterial(e){return [e.id,e.createdAt,e.sealedAt??"",e.title,e.category,e.note,(e.imageId||""),(e.moodKey||"")].join("|")}

/* ===================== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º ===================== */
function CalendarView({ entries }) {
  const [year, setYear] = React.useState(new Date().getFullYear());
  const [month, setMonth] = React.useState(new Date().getMonth()); // 0=Jan
  const first = new Date(year, month, 1);
  const startWeekDay = first.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const cells = [];
  for (let i = 0; i < startWeekDay; i++) cells.push(null);
  for (let d = 1; d <= daysInMonth; d++) cells.push(d);
  while (cells.length % 7 !== 0) cells.push(null);

  const mapByDay = {};
  for (const e of entries) {
    const dt = new Date(e.createdAt);
    if (dt.getFullYear() === year && dt.getMonth() === month) {
      const d = dt.getDate();
      (mapByDay[d] ||= []).push(e);
    }
  }
  function move(delta){
    const m = month + delta;
    const base = new Date(year, m, 1);
    setYear(base.getFullYear());
    setMonth(base.getMonth());
  }

  return React.createElement('div', null,
    React.createElement('div',{className:"flex items-center justify-between mb-3"},
      React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>move(-1)},"â† å‰æœˆ"),
      React.createElement('h3',{className:"font-semibold"}, `${year}å¹´ ${month+1}æœˆ`),
      React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>move(1)},"ç¿Œæœˆ â†’")
    ),
    React.createElement('div',{className:"grid grid-cols-7 text-center text-xs text-slate-500 mb-1"},
      ...["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].map(w => React.createElement('div',{key:w,className:"py-1"}, w))
    ),
    React.createElement('div',{className:"grid grid-cols-7 gap-1"},
      ...cells.map((d,idx)=>{
        const todayItems = d ? (mapByDay[d] || []) : [];
        return React.createElement('div',{key:idx,className:"min-h-24 border rounded-lg p-1 bg-white"},
          React.createElement('div',{className:"text-right text-xs text-slate-500"}, d ? d : ""),
          todayItems.slice(0,3).map(item =>
            React.createElement('div',{key:item.id,className:"mt-1 text-[11px] truncate px-1 py-0.5 rounded bg-slate-100"},
              (item.title || "ï¼ˆç„¡é¡Œï¼‰")
            )
          ),
          todayItems.length > 3 &&
            React.createElement('div',{className:"mt-1 text-[11px] text-right text-slate-500"}, `+${todayItems.length-3} ä»¶`)
        );
      })
    )
  );
}
/* ===================== ç›¸è«‡ç”¨PDFï¼ˆå°åˆ·å°‚ç”¨ï¼‰ã“ã“ã ã‘è¿½åŠ  ===================== */
function escapeHtml(s=""){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function buildConsultHtml(entries, imagesMap={}){
  const rows = entries.map((e,i)=>{
    const img = e.imageId ? imagesMap?.[e.imageId] : null;
    const mood = e.moodKey ? (MOODS.find(m=>m.key===e.moodKey)?.label || e.moodKey) : "";
    const moodEmoji = e.moodKey ? (MOODS.find(m=>m.key===e.moodKey)?.emoji || "") : "";

    return `
      <section class="card">
        <div class="meta">
          <span>No.${i+1}</span>
          <span>ä½œæˆï¼š${escapeHtml(jpTime(e.createdAt))}</span>
          ${e.sealedAt ? `<span>å°å°ï¼š${escapeHtml(jpTime(e.sealedAt))}</span>` : ``}
        </div>

        <h2 class="title">${escapeHtml(e.title || "ï¼ˆç„¡é¡Œï¼‰")}</h2>

        <div class="tags">
          <span class="tag">ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(e.category || "")}</span>
          ${mood ? `<span class="tag">æ°—æŒã¡ï¼š${escapeHtml(moodEmoji + " " + mood)}</span>` : ``}
        </div>

        ${img ? `<img class="img" src="${img}" alt="æ·»ä»˜ç”»åƒ">` : ``}

        <pre class="body">${escapeHtml(e.note || "")}</pre>

        <div class="hash">
          <div>æ”¹ã–ã‚“æ¤œçŸ¥ãƒãƒƒã‚·ãƒ¥ï¼š${escapeHtml(e.hash || "")}</div>
          <div>å‰ãƒãƒƒã‚·ãƒ¥ï¼š${escapeHtml(e.prevHash || "")}</div>
        </div>
      </section>
    `;
  }).join("");

  return `
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Memoï¼‹ ç›¸è«‡ç”¨PDF</title>
<style>
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; background:#f5f7fb; }
  .wrap{ max-width: 860px; margin: 0 auto; padding: 18px; }
  .header{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; }
  .h1{ font-size:18px; font-weight:700; margin:0 0 6px; }
  .sub{ font-size:12px; color:#475569; margin:0; line-height:1.4; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; margin-top:12px; page-break-inside: avoid; }
  .meta{ display:flex; gap:12px; flex-wrap:wrap; font-size:12px; color:#64748b; }
  .title{ margin:8px 0 6px; font-size:16px; }
  .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .tag{ font-size:12px; background:#f1f5f9; border:1px solid #e2e8f0; padding:3px 8px; border-radius:999px; color:#334155; }
  .img{ width:100%; max-height: 360px; object-fit:contain; border:1px solid #e5e7eb; border-radius:10px; margin:10px 0; }
  .body{ white-space:pre-wrap; font-size:13px; line-height:1.6; margin:0; }
  .hash{ margin-top:10px; font-size:11px; color:#64748b; border-top:1px dashed #e2e8f0; padding-top:8px; word-break:break-all; }

  @media print{
    body{ background:#fff; }
    .wrap{ padding:0; }
    .header{ border:none; border-bottom:1px solid #e5e7eb; border-radius:0; }
    .card{ border:1px solid #d1d5db; border-radius:10px; }
    .sub{ color:#111827; }
    @page { margin: 12mm; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <p class="h1">Memoï¼‹ ç›¸è«‡ç”¨PDFï¼ˆå°åˆ·ï¼‰</p>
      <p class="sub">
        å‡ºåŠ›æ—¥æ™‚ï¼š${escapeHtml(jpTime(new Date().toISOString()))}<br>
        â€» æå‡ºç”¨ã«æ–‡ç« ã®ã¿æ•´å½¢ã—ãŸå°åˆ·å°‚ç”¨ãƒšãƒ¼ã‚¸ã§ã™ï¼ˆæ¤œç´¢çª“ãƒ»ãƒœã‚¿ãƒ³ç­‰ã¯å‡ºã¾ã›ã‚“ï¼‰
      </p>
    </div>

    ${rows || `<div class="card"><p class="body">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`}
  </div>

<script>
  window.onload = () => { setTimeout(()=>window.print(), 200); };
<\/script>
</body>
</html>
  `;
}

function printConsultPDF(entries, imagesMap){
  const html = buildConsultHtml(entries, imagesMap);
  const w = window.open("", "_blank");
  if(!w){
    alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ===================== App ===================== */
function App(){
  const [store,setStore]=useState(null);
  const [password,setPassword]=useState("");      // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³PW
  const [locked,setLocked]=useState(false);
  const [hasEncrypted,setHasEncrypted]=useState(false);
  const [msg,setMsg]=useState("");

  // çµã‚Šè¾¼ã¿ãƒ»æ¤œç´¢
  const [filterCat,setFilterCat]=useState("all");
  const [searchMode,setSearchMode]=useState("AND");
  const [searchText,setSearchText]=useState("");
  const [sortMode,setSortMode]=useState("newest");

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸€è¦§/ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰
  const [viewMode, setViewMode] = useState("list"); // "list" | "calendar"

  useEffect(()=>{
    const encPayload=localStorage.getItem(LS_KEY+"_enc");
    if(encPayload){setHasEncrypted(true);setLocked(true);}
    else{
      const plain=localStorage.getItem(LS_KEY);
      setStore(plain?JSON.parse(plain):emptyStore());
    }
  },[]);
  useEffect(()=>{if(hasEncrypted)setLocked(true)},[hasEncrypted]);

  async function persist(next){
    if(next.requiresPassword){
      if(!password){setMsg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªå…¥åŠ›ã€‚ãƒ­ãƒƒã‚¯è¨­å®šã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­ã€‚");return;}
      const encObj=await encryptJson(next,password);
      localStorage.removeItem(LS_KEY);
      localStorage.setItem(LS_KEY+"_enc",JSON.stringify(encObj));
      setHasEncrypted(true);
    }else{
      localStorage.removeItem(LS_KEY+"_enc");
      localStorage.setItem(LS_KEY,JSON.stringify(next));
      setHasEncrypted(false);
    }
    setStore(next);
  }
  async function unlock(pw){
    try{
      const payload=JSON.parse(localStorage.getItem(LS_KEY+"_enc"));
      const data=await decryptJson(payload,pw);
      setPassword(pw);setStore(data);setLocked(false);setMsg("");
    }catch{setMsg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");}
  }

  // ç”»åƒ
  async function addImage(file){
    if(!file) return {id:null};
    if(!/image\/(png|jpeg)/.test(file.type)){setMsg("PNG/JPEGã®ã¿è¨±å¯");return {id:null};}
    if(file.size>5*1024*1024){setMsg("ç”»åƒã¯5MBä»¥ä¸‹ã«ã—ã¦ã­");return {id:null};}
    const r=new FileReader();
    const dataURL=await new Promise((res,rej)=>{r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});
    const id=uuid();
    await persist({...store,images:{...(store.images||{}),[id]:dataURL}});
    return {id};
  }

  // CRUD
  async function addEntry({title,category,note,imageId,moodKey}){
    const now=new Date().toISOString();
    const prev=store.entries[store.entries.length-1]?.hash ?? "GENESIS";
    const draft={id:uuid(),createdAt:now,sealedAt:null,title:title.trim(),category,note,imageId:imageId||null,moodKey:moodKey||null,prevHash:prev,hash:""};
    draft.hash=await sha256Hex(prev+"|"+entryMaterial(draft));
    await persist({...store,entries:[...store.entries,draft]});
    if(moodKey){setMsg(pickSupport(moodKey));setTimeout(()=>setMsg(""),6000);}
  }
  async function editEntry(id,fields){
    const idx=store.entries.findIndex(e=>e.id===id); if(idx<0||store.entries[idx].sealedAt) return;
    const arr=[...store.entries]; arr[idx]={...arr[idx],...fields};
    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){arr[i].prevHash=prev;arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));prev=arr[i].hash;}
    await persist({...store,entries:arr});
  }
  async function sealEntry(id){
    const idx=store.entries.findIndex(e=>e.id===id); if(idx<0||store.entries[idx].sealedAt) return;
    const arr=[...store.entries]; arr[idx]={...arr[idx],sealedAt:new Date().toISOString()};
    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){arr[i].prevHash=prev;arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));prev=arr[i].hash;}
    await persist({...store,entries:arr});
  }
  async function removeEntry(id){
    const idx=store.entries.findIndex(e=>e.id===id); if(idx<0||store.entries[idx].sealedAt) return;
    const arr=store.entries.filter(e=>e.id!==id);
    let prev="GENESIS";
    for(let i=0;i<arr.length;i++){arr[i].prevHash=prev;arr[i].hash=await sha256Hex(prev+"|"+entryMaterial(arr[i]));prev=arr[i].hash;}
    await persist({...store,entries:arr});
  }

  // I/O
  function exportJson(){
    const blob=new Blob([JSON.stringify(store,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download=`memo-plus-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
    a.click(); URL.revokeObjectURL(url);
  }
  function importJson(file){
    const r=new FileReader();
    r.onload=async()=>{try{const obj=JSON.parse(r.result); if(!Array.isArray(obj.entries)) throw 0; await persist(obj);}catch{setMsg("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—")}};
    r.readAsText(file);
  }

  // çµã‚Šè¾¼ã¿/æ¤œç´¢/ä¸¦ã³æ›¿ãˆ
  function filteredEntries(){
    let arr=[...store.entries];
    if(filterCat!=="all") arr=arr.filter(e=>e.category===filterCat);
    if(searchText.trim()){
      const words=searchText.trim().split(/\s+/);
      arr=arr.filter(e=>{
        const hay=(e.title+e.note+(e.moodKey||"")).toLowerCase();
        return (searchMode==="AND") ? words.every(w=>hay.includes(w.toLowerCase()))
                                    : words.some(w=>hay.includes(w.toLowerCase()));
      });
    }
    if(sortMode==="newest") arr.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    if(sortMode==="oldest") arr.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));
    return arr;
  }

  // ãƒ­ãƒƒã‚¯ç”»é¢
  if(locked&&hasEncrypted){
    return React.createElement('div',{className:"min-h-screen bg-slate-50 p-6"},
      React.createElement('div',{className:"max-w-xl mx-auto bg-white rounded-2xl shadow p-6"},
        React.createElement('h1',{className:"text-2xl font-bold mb-2"},"ğŸ” Memoï¼‹ï¼ˆéµä»˜ãï¼‰"),
        React.createElement('p',{className:"text-sm text-slate-600 mb-6"},"ç«¯æœ«å†…ã®æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§è§£éŒ ã—ã¦ãã ã•ã„ã€‚"),
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",onChange:e=>setPassword(e.target.value)}),
        React.createElement('button',{onClick:()=>unlock(password),className:"mt-4 w-full rounded-xl p-3 bg-slate-900 text-white"},"è§£éŒ ã™ã‚‹"),
        msg && React.createElement('p',{className:"mt-3 text-red-600 text-sm"},msg)
      ));
  }
  if(!store) return React.createElement('div',{className:"p-6"},"èª­ã¿è¾¼ã¿ä¸­â€¦");

  return React.createElement(React.Fragment,null,
    React.createElement('header',{className:"sticky top-0 bg-white/90 border-b z-10"},
      React.createElement('div',{className:"max-w-5xl mx-auto px-4 py-3 flex flex-wrap gap-2 items-center justify-between"},
        React.createElement('h1',{className:"font-bold text-xl"},"Memoï¼‹ï¼ˆæ”¹ã–ã‚“æ¤œçŸ¥ãƒ»éµä»˜ãï¼‰"),
        React.createElement('div',{className:"flex flex-wrap gap-2"},
          React.createElement('button',{className:"px-3 py-2 rounded-lg border",onClick:()=>printConsultPDF(filteredEntries(), store.images)
},"ç›¸è«‡ç”¨PDF"),
          React.createElement('button',{className:"px-3 py-2 rounded-lg border",onClick:exportJson},"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"),
          React.createElement('label',{className:"px-3 py-2 rounded-lg border cursor-pointer"},"ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
            React.createElement('input',{type:"file",accept:"application/json",className:"hidden",onChange:e=>e.target.files?.[0]&&importJson(e.target.files[0])})
          ),
          /* ã“ã“ã‹ã‚‰ï¼šä¸€è¦§/ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
          React.createElement('button',{
            className:"px-3 py-2 rounded-lg border "+(viewMode==="list"?"bg-slate-900 text-white":""),
            onClick:()=>setViewMode("list")
          },"ä¸€è¦§"),
          React.createElement('button',{
            className:"px-3 py-2 rounded-lg border "+(viewMode==="calendar"?"bg-slate-900 text-white":""),
            onClick:()=>setViewMode("calendar")
          },"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼")
          /* ã“ã“ã¾ã§ */
        )
      )
    ),

    React.createElement('main',{className:"max-w-5xl mx-auto p-4 grid gap-6 sm:grid-cols-5"},
      /* å·¦ã‚«ãƒ©ãƒ ï¼šæ–°è¦è¨˜éŒ²ï¼‹ãƒ­ãƒƒã‚¯ */
      React.createElement('div',{className:"sm:col-span-2"},
        React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
          React.createElement('h2',{className:"font-semibold mb-3"},"ğŸ“ æ–°è¦è¨˜éŒ²"),
          msg && React.createElement('div',{className:"mb-3 text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2"},"ğŸ’¬ ",msg),
          React.createElement(NewEntryForm,{onSubmit: async({title,category,note,file,moodKey})=>{
            let imageId=null; if(file){const r=await addImage(file); imageId=r.id;}
            await addEntry({title,category,note,imageId,moodKey});
          }})
        ),
        React.createElement('section',{className:"bg-white rounded-2xl shadow p-4 mt-4"},
          React.createElement('h2',{className:"font-semibold mb-3"},"ğŸ” ãƒ­ãƒƒã‚¯è¨­å®š"),
          React.createElement(LockPanel,{store,setStore,password,setPassword,persist,setMsg})
        )
      ),

      /* å³ã‚«ãƒ©ãƒ ï¼šä¸€è¦§ or ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
      React.createElement('div',{className:"sm:col-span-3"},
        React.createElement('section',{className:"bg-white rounded-2xl shadow p-4"},
          viewMode === "list"
          ? React.createElement(React.Fragment,null,
              React.createElement('div',{className:"flex flex-wrap gap-2 mb-3"},
                React.createElement('select',{value:filterCat,onChange:e=>setFilterCat(e.target.value),className:"border rounded-lg p-2"},
                  React.createElement('option',{value:"all"},"ã™ã¹ã¦"),
                  ['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(c=>React.createElement('option',{key:c,value:c},c))
                ),
                React.createElement('select',{value:searchMode,onChange:e=>setSearchMode(e.target.value),className:"border rounded-lg p-2"},
                  React.createElement('option',{value:"AND"},"ANDæ¤œç´¢"),
                  React.createElement('option',{value:"OR"},"ORæ¤œç´¢")
                ),
                React.createElement('input',{type:"text",placeholder:"æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰",value:searchText,onChange:e=>setSearchText(e.target.value),className:"flex-1 border rounded-lg p-2"}),
                React.createElement('select',{value:sortMode,onChange:e=>setSortMode(e.target.value),className:"border rounded-lg p-2"},
                  React.createElement('option',{value:"newest"},"æ–°ã—ã„é †"),
                  React.createElement('option',{value:"oldest"},"å¤ã„é †")
                )
              ),
              filteredEntries().length===0
                ? React.createElement('p',{className:"text-sm text-slate-500"},"è©²å½“ã™ã‚‹è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
                : React.createElement('ul',{className:"space-y-3"},
                    filteredEntries().map(e=>React.createElement(EntryCard,{key:e.id,e,images:store.images,editEntry,sealEntry,removeEntry}))
                  )
            )
          : React.createElement(CalendarView,{entries:store.entries})
        )
      )
    )
  );
}

/* -------------- æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ  -------------- */
function NewEntryForm({onSubmit}){
  const [title,setTitle]=useState("");
  const [category,setCategory]=useState("è¦³å¯Ÿ");
  const [note,setNote]=useState("");
  const [file,setFile]=useState(null);
  const [mood,setMood]=useState(null);

  const handle=async(e)=>{
    e.preventDefault();
    if(!title.trim()&&!note.trim()&&!file) return;
    await onSubmit({title,category,note,file,moodKey:mood});
    setTitle(""); setCategory("è¦³å¯Ÿ"); setNote(""); setFile(null); setMood(null);
    e.target.reset();
  };

  return React.createElement('form',{onSubmit:handle,className:"space-y-3"},
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰"),
      React.createElement('input',{value:title,onChange:e=>setTitle(e.target.value),className:"w-full border rounded-xl p-3",placeholder:"ä¾‹ï¼šè¬›ç¿’ã¨è¨€ã£ã¦å¤–å‡º / æ”¯å‡ºãƒ¡ãƒ¢ / ä¼šè©±ã®è¦ç‚¹ ãªã©"})
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ã‚«ãƒ†ã‚´ãƒªãƒ¼"),
      React.createElement('select',{value:category,onChange:e=>setCategory(e.target.value),className:"w-full border rounded-xl p-3"},['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(x=>React.createElement('option',{key:x,value:x},x)))
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"æœ¬æ–‡"),
      React.createElement('textarea',{value:note,onChange:e=>setNote(e.target.value),className:"w-full border rounded-xl p-3 h-32",placeholder:`ä¾‹ï¼š${new Date().toLocaleString('ja-JP',{timeZone:'Asia/Tokyo',hour12:false})} è‡ªå®…ã‚’å‡ºç™ºã€‚ã‚³ãƒ³ãƒ“ãƒ‹ã§â—¯â—¯ã‚’è³¼å…¥ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆæ·»ä»˜ï¼‰ã€‚ãã®å¾Œâ—¯â—¯æ–¹é¢ã¸ã€‚å¸°å®…ã¯21:05ã€‚ä¼šè©±ã®è¦ç‚¹ï¼šâ€¦â€¦`})
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ä»Šæ—¥ã®æ°—æŒã¡ï¼ˆä»»æ„ï¼‰"),
      React.createElement('div',{className:"flex flex-wrap gap-2"},
        ...MOODS.map(m=>React.createElement('button',{type:"button",key:m.key,onClick:()=>setMood(m.key),
          className:"px-3 py-1 rounded-full border "+(mood===m.key?"bg-slate-900 text-white":"bg-white text-slate-700")},`${m.emoji} ${m.label}`))
      )
    ),
    React.createElement('div',null,
      React.createElement('label',{className:"block text-sm font-medium mb-1"},"ç”»åƒï¼ˆä»»æ„ãƒ»PNG/JPEGãƒ»5MBä»¥ä¸‹ï¼‰"),
      React.createElement('input',{type:"file",accept:"image/png,image/jpeg",onChange:e=>setFile(e.target.files?.[0]||null),className:"w-full border rounded-xl p-3"})
    ),
    React.createElement('button',{type:"submit",className:"w-full rounded-xl bg-slate-900 text-white p-3"},"ä»Šã™ãè¨˜éŒ²")
  );
}

/* -------------- ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -------------- */
function EntryCard({e,images,editEntry,sealEntry,removeEntry}){
  const [editing,setEditing]=useState(false);
  const [title,setTitle]=useState(e.title);
  const [category,setCategory]=useState(e.category);
  const [note,setNote]=useState(e.note);
  const img = e.imageId ? (images||{})[e.imageId] : null;
  useEffect(()=>{setTitle(e.title);setCategory(e.category);setNote(e.note);},[e]);
  const moodDef = e.moodKey ? MOODS.find(m=>m.key===e.moodKey) : null;

  return React.createElement('li',{className:"rounded-xl border border-slate-200 bg-white p-4"},
    React.createElement('div',{className:"text-xs text-slate-500"},"ä½œæˆ: ",jpTime(e.createdAt), e.sealedAt?` ï¼ å°å°: ${jpTime(e.sealedAt)}`:""),
    editing ? React.createElement('div',{className:"mt-2 space-y-2"},
      React.createElement('input',{className:"w-full border rounded-xl p-2",value:title,onChange:e=>setTitle(e.target.value)}),
      React.createElement('select',{className:"w-full border rounded-xl p-2",value:category,onChange:e=>setCategory(e.target.value)},['è¦³å¯Ÿ','ä¼šè©±','æ”¯å‡º','å ´æ‰€','ãã®ä»–'].map(x=>React.createElement('option',{key:x,value:x},x))),
      React.createElement('textarea',{className:"w-full border rounded-xl p-2 h-28",value:note,onChange:e=>setNote(e.target.value)})
    ) : React.createElement(React.Fragment,null,
      React.createElement('h3',{className:"mt-1 font-semibold"},e.title||"ï¼ˆç„¡é¡Œï¼‰"),
      React.createElement('div',{className:"flex gap-2 items-center mt-1"},
        React.createElement('span',{className:"text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border"},e.category),
        moodDef && React.createElement('span',{className:"text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 border"},`${moodDef.emoji} ${moodDef.label}`)
      ),
      img ? React.createElement('img',{src:img,alt:"æ·»ä»˜ç”»åƒ",className:"mt-3 max-h-64 rounded-lg border"}) : null,
      React.createElement('p',{className:"mt-2 whitespace-pre-wrap text-sm"},e.note)
    ),
    React.createElement('div',{className:"mt-3 flex items-center gap-2"},
      !e.sealedAt ? React.createElement(React.Fragment,null,
        editing ? React.createElement(React.Fragment,null,
          React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>setEditing(false)},"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"),
          React.createElement('button',{className:"px-3 py-1 rounded-lg bg-slate-900 text-white",onClick:()=>editEntry(e.id,{title,category,note})},"ä¿å­˜")
        ) : React.createElement(React.Fragment,null,
          React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>setEditing(true)},"ç·¨é›†"),
          React.createElement('button',{className:"px-3 py-1 rounded-lg border",onClick:()=>removeEntry(e.id)},"å‰Šé™¤"),
          React.createElement('button',{className:"ml-auto px-3 py-1 rounded-lg bg-emerald-600 text-white",onClick:()=>sealEntry(e.id)},"å°å°ï¼ˆç¢ºå®šï¼‰")
        )
      ) : React.createElement('span',{className:"ml-auto text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border"},"å°å°æ¸ˆã¿ãƒ»ç·¨é›†ä¸å¯")
    )
  );
}

/* -------------- ãƒ­ãƒƒã‚¯è¨­å®š -------------- */
function LockPanel({store,setStore,password,setPassword,persist,setMsg}){
  const [pw1,setPw1]=useState(""), [pw2,setPw2]=useState("");
  if(!store.requiresPassword){
    return React.createElement('div',null,
      React.createElement('p',{className:"text-sm text-slate-600"},"ç¾åœ¨ï¼š",React.createElement('span',{className:"font-semibold"},"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®š"),"ï¼ˆå¹³æ–‡ä¿å­˜ï¼‰"),
      React.createElement('div',{className:"mt-3 space-y-2"},
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",value:pw1,onChange:e=>setPw1(e.target.value)}),
        React.createElement('input',{type:"password",className:"w-full border rounded-xl p-3",placeholder:"ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",value:pw2,onChange:e=>setPw2(e.target.value)}),
        React.createElement('button',{disabled:!pw1||pw1!==pw2,onClick:async()=>{const next={...(store||emptyStore()),requiresPassword:true}; await persist(next); setPassword(pw1); setMsg("æš—å·åŒ–ä¿å­˜ã«åˆ‡æ›¿ãˆã¾ã—ãŸï¼ˆä»¥å¾Œã¯è§£éŒ ãŒå¿…è¦ï¼‰");},className:"w-full rounded-xl bg-slate-900 text-white p-3 disabled:opacity-40"},"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦æš—å·åŒ–ä¿å­˜ã«åˆ‡æ›¿")
      ),
      React.createElement('p',{className:"mt-2 text-xs text-slate-500"},"â€» å¿˜ã‚Œã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€‚å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã‚’ã€‚")
    );
  }
  return React.createElement('div',null,
    React.createElement('p',{className:"text-sm text-slate-600"},"ç¾åœ¨ï¼š",React.createElement('span',{className:"font-semibold"},"æš—å·åŒ–ä¿å­˜"),"ï¼ˆAES-GCMï¼‰"),
    React.createElement('div',{className:"mt-2"},
      React.createElement('button',{onClick:()=>{setStore(null);localStorage.setItem(LS_KEY+"_enc",localStorage.getItem(LS_KEY+"_enc")||"");location.reload();},className:"w-full rounded-xl border p-3"},"ä»Šã™ãç”»é¢ã‚’ãƒ­ãƒƒã‚¯")
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>

<!-- ===== PWAï¼šmanifestå‹•çš„ç”Ÿæˆ & Service Workerç™»éŒ²ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµï¼‰ ===== -->
<script>
(function(){
  const manifest = {
    name: "Memoï¼‹",
    short_name: "Memoï¼‹",
    start_url: "./index.html",
    scope: "./",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#0f172a",
    icons: [{ src: "./icon.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }]
  };
  const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"}));
  document.getElementById("manifest-link").setAttribute("href", url);

  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE='memo-plus-v8';
      const ASSETS=['./','./index.html','./icon.png'];
      self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));});
      self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));});
      self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(x=>{const y=x.clone(); caches.open(CACHE).then(c=>c.put(e.request,y)); return x;})));});
    `;
    const swUrl = URL.createObjectURL(new Blob([swCode],{type:"text/javascript"}));
    window.addEventListener('load', ()=>navigator.serviceWorker.register(swUrl,{scope:"./"}));
  }
})();
</script>
</body>
</html>
